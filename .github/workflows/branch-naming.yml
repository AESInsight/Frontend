name: Branch Naming Convention

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - develop
      - main

jobs:
  validate-branch-name:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get branch name
        id: branch_name
        shell: bash
        run: echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV

      - name: Check if merge from develop into main
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
            if [[ "$LAST_COMMIT_MSG" == *"Merge branch 'develop'"* ]]; then
              echo "Skipping branch name validation for develop merge into main."
              exit 0
            fi
          fi

      - name: Validate branch naming convention
        shell: bash
        run: |
          if [[ ! "$BRANCH_NAME" =~ ^(fix|feat|test|pull)/[0-9]+/[^_]+$ ]]; then
            echo "‚ùå Invalid branch name: '$BRANCH_NAME'"
            echo "‚úÖ Expected format: '<scope>/<issue number>/<branch-name>'"
            echo "üîπ Scope must be 'fix', 'feat', or 'test'"
            echo "üîπ Issue number must be a valid number"
            echo "üîπ Branch name must use '-' instead of '_'"
            exit 1
          fi

      - name: Success Message
        shell: bash
        run: echo "‚úÖ Branch name '$BRANCH_NAME' is valid!"
